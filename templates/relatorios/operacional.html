{% extends "core/base.html" %}
{% load static %}
{% block extra_css %}
<style>
  /* Layout enxuto para filtros do relat√≥rio operacional */
  #rel-oper .filters-grid{ display:grid; grid-template-columns: 1fr; gap:8px; }
  @media (min-width: 540px){
    #rel-oper .filters-grid{ grid-template-columns: auto auto auto; align-items:end; justify-content:flex-start; column-gap:6px; }
    #rel-oper .filters-card input[type="date"]{ width: 150px; }
  }
  #rel-oper .filters-card label{ font-size: .95rem; }
  #rel-oper .filters-card input{ font-size: 1rem; min-height: 38px; }
  #rel-oper .filters-card .f-actions{ display:flex; flex-direction:column; justify-content:flex-end; }
  #rel-oper .filters-card .f-actions .btn{ white-space:nowrap; }
  #rel-oper .page-title{ font-size: 1.3rem; }
</style>
{% endblock %}
{% block content %}

<div class="container mt-4" id="rel-oper">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="page-title mb-0">üìä Relat√≥rio Operacional</h2>
    <div>
      <a href="?inicio={{ data.periodo.inicio|date:'Y-m-d' }}&fim={{ data.periodo.fim|date:'Y-m-d' }}&format=csv" class="btn btn-sm btn-outline-primary">Exportar CSV</a>
    </div>
  </div>

  <form method="get" class="card p-3 shadow-sm filters-card">
    <div class="filters-grid">
      <div class="f">
        <label class="form-label mb-1">In√≠cio</label>
        <input type="date" name="inicio" value="{{ data.periodo.inicio|date:'Y-m-d' }}" class="form-control form-control-sm">
      </div>
      <div class="f">
        <label class="form-label mb-1">Fim</label>
        <input type="date" name="fim" value="{{ data.periodo.fim|date:'Y-m-d' }}" class="form-control form-control-sm">
      </div>
      <div class="f f-actions">
        <label class="form-label mb-1">&nbsp;</label>
        <button type="submit" class="btn btn-primary btn-sm">Gerar</button>
      </div>
    </div>
  </form>

  <div class="table-card shadow-sm">
    <div class="table-head"><div><strong>Per√≠odo:</strong> {{ data.periodo.inicio|date:"d/m/Y" }} a {{ data.periodo.fim|date:"d/m/Y" }}</div></div>
    <div class="table-wrap table-responsive">
      <table class="table table-striped table-hover table-sm table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>M√≥dulo</th>
            <th class="text-right">Entradas</th>
            <th class="text-right">Sa√≠das</th>
            <th class="text-right">Processos Ativos</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Den√∫ncias</td>
            <td class="text-right">{{ data.denuncias.entradas }}</td>
            <td class="text-right">{{ data.denuncias.saidas }}</td>
            <td class="text-right">{{ data.denuncias.ativos }}</td>
          </tr>
          <tr>
            <td>Notifica√ß√µes</td>
            <td class="text-right">{{ data.notificacoes.entradas }}</td>
            <td class="text-right">{{ data.notificacoes.saidas }}</td>
            <td class="text-right">{{ data.notificacoes.ativos }}</td>
          </tr>
          <tr>
            <td>Autos de Infra√ß√£o</td>
            <td class="text-right">{{ data.aif.entradas }}</td>
            <td class="text-right">{{ data.aif.saidas }}</td>
            <td class="text-right">{{ data.aif.ativos }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card p-3 shadow-sm" style="margin-top:12px;">
    <h3 style="margin:0 0 8px;">Vis√£o Gr√°fica (por m√≥dulo)</h3>
    <div style="max-width:960px;">
      <canvas id="chart-oper" height="160"></canvas>
    </div>
    <small class="hint">Entradas, Sa√≠das e Processos Ativos para cada m√≥dulo.</small>
  </div>

</div>

{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
  (function(){
    try{
      const ctx = document.getElementById('chart-oper');
      if(!ctx || !window.Chart) return;
      if(window.ChartDataLabels){ Chart.register(window.ChartDataLabels); }
      const labels = ['Den√∫ncias','Notifica√ß√µes','AIF'];
      const entradas = [
        {{ data.denuncias.entradas|default:0 }},
        {{ data.notificacoes.entradas|default:0 }},
        {{ data.aif.entradas|default:0 }}
      ];
      const saidas = [
        {{ data.denuncias.saidas|default:0 }},
        {{ data.notificacoes.saidas|default:0 }},
        {{ data.aif.saidas|default:0 }}
      ];
      const ativos = [
        {{ data.denuncias.ativos|default:0 }},
        {{ data.notificacoes.ativos|default:0 }},
        {{ data.aif.ativos|default:0 }}
      ];
      const labelColor = getComputedStyle(document.body).color || '#111827';
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Entradas', data: entradas, backgroundColor: '#60a5fa' },
            { label: 'Sa√≠das', data: saidas, backgroundColor: '#34d399' },
            { label: 'Processos Ativos', data: ativos, backgroundColor: '#fbbf24' }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { precision:0 } }
          },
          plugins: {
            datalabels: {
              anchor: 'end',
              align: 'end',
              clamp: true,
              offset: 2,
              color: labelColor,
              font: { weight: '600', size: 12 },
              formatter: (v) => v
            }
          }
        }
      });
    }catch(e){ /* silencioso */ }
  })();
  </script>
{% endblock %}
