{% extends "core/base.html" %}
{% load static %}
{% block title %}Nova Den√∫ncia ‚Äî SISALVWEB{% endblock %}

{% block content %}
<div class="container mt-3">

  <!-- Cabe√ßalho -->
  <h2 class="page-title">üìù Cadastrar Den√∫ncia</h2>
  <div class="text-muted" style="margin-bottom:10px; font-size:.95rem;">
    <strong>(*) Campos obrigat√≥rios</strong>
  </div>
  <div style="margin-bottom:10px;">
    <a href="{% url 'denuncias:listar' %}" class="btn btn-sm btn-secondary">‚Üê Voltar para a Listagem</a>
  </div>

  <!-- Mensagens -->
  {% if messages %}
    <div class="mb-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Erros principais -->
  {% if form.errors or form.non_field_errors %}
    <div class="alert alert-danger">
      <strong>Erros encontrados:</strong>
      <ul style="margin:6px 0 0 18px;">
        {% for field in form %}{% for err in field.errors %}<li><strong>{{ field.label }}:</strong> {{ err }}</li>{% endfor %}{% endfor %}
        {% for err in form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- Formul√°rio -->
  <div class="card p-3">
    <form method="post" class="denuncia-form" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      <!-- ORIGEM -->
      <div class="section">
        <h3>Origem da den√∫ncia</h3>
        <div class="form-grid">
          <div class="field"><label>Origem</label>{{ form.origem_denuncia }}</div>
          <div class="field"><label>An√¥nima?</label>{{ form.denunciante_anonimo }}</div>
          <div class="field"><label>Fiscal denunciante</label>{{ form.denunciante_fiscal }}</div>

          <div class="field"><label>Nome (contribuinte)</label>{{ form.denunciante_nome }}</div>
          <div class="field"><label>E-mail (contribuinte)</label>{{ form.denunciante_email }}</div>
          <div class="field"><label>Telefone (contribuinte)</label>{{ form.denunciante_telefone }}</div>
        </div>
      </div>

      <!-- DENUNCIADO -->
      <div class="section">
        <h3>Denunciado (alvo)</h3>
        <div class="form-grid">
          <div class="field"><label>Tipo de pessoa</label>{{ form.denunciado_tipo_pessoa }}</div>
          <div class="field"><label>Nome/Raz√£o social <span aria-hidden="true" style="color:#c00">*</span></label>{{ form.denunciado_nome_razao }}</div>
          <div class="field"><label>CPF/CNPJ</label>{{ form.denunciado_cpf_cnpj }}</div>

          <div class="field"><label>RG/IE</label>{{ form.denunciado_rg_ie }}</div>
          <div class="field"><label>E-mail</label>{{ form.denunciado_email }}</div>
          <div class="field"><label>Telefone</label>{{ form.denunciado_telefone }}</div>

          <div class="field"><label>CEP</label>{{ form.denunciado_res_cep }}</div>
          <div class="field"><label>Logradouro</label>{{ form.denunciado_res_logradouro }}</div>
          <div class="field"><label>N√∫mero</label>{{ form.denunciado_res_numero }}</div>
          <div class="field"><label>Complemento</label>{{ form.denunciado_res_complemento }}</div>

          <div class="field"><label>Bairro</label>{{ form.denunciado_res_bairro }}</div>
          <div class="field"><label>Cidade</label>{{ form.denunciado_res_cidade }}</div>
          <div class="field"><label>UF</label>{{ form.denunciado_res_uf }}</div>
          
        </div>
      </div>

      <!-- LOCAL DA OCORR√äNCIA -->
      <div class="section">
        <h3>
          Local da ocorr√™ncia
          <button type="button" id="btnCopyEndereco" class="btn btn-sm btn-outline-primary" title="Repetir endere√ßo do denunciado" style="margin-left:8px;">
            Repetir do denunciado
          </button>
        </h3>
        <div class="form-grid">
          <div class="field"><label>CEP</label>{{ form.local_oco_cep }}</div>
          <div class="field"><label>Logradouro <span aria-hidden="true" style="color:#c00">*</span></label>{{ form.local_oco_logradouro }}</div>
          <div class="field"><label>N¬∫ / Lote / Quadra</label>{{ form.local_oco_numero }}</div>
          <div class="field"><label>Complemento</label>{{ form.local_oco_complemento }}</div>

          <div class="field"><label>Bairro <span aria-hidden="true" style="color:#c00">*</span></label>{{ form.local_oco_bairro }}</div>
          <div class="field"><label>Cidade <span aria-hidden="true" style="color:#c00">*</span></label>{{ form.local_oco_cidade }}</div>
          <div class="field"><label>UF <span aria-hidden="true" style="color:#c00">*</span></label>{{ form.local_oco_uf }}</div>

          
          <div class="field"><label>Latitude</label>{{ form.local_oco_lat }}</div>
          <div class="field"><label>Longitude</label>{{ form.local_oco_lng }}</div>

          <div class="field span-3">
            <label>Descri√ß√£o detalhada <span aria-hidden="true" style="color:#c00">*</span></label>
            {{ form.descricao_oco }}
          </div>
        </div>
      </div>

      <!-- DOCUMENTOS DO IM√ìVEL -->
      {% if doc_formset %}
      <div class="section">
        <h3>Documentos do im√≥vel</h3>
        <p class="hint" style="margin:-6px 0 8px;">‚ÄúTipo‚Äù e ‚ÄúArquivo‚Äù s√£o obrigat√≥rios para cada linha utilizada.</p>
        {{ doc_formset.management_form }}
        <div class="form-grid-2">
          {% for f in doc_formset.forms %}
            <div style="border:1px dashed #ccc; padding:10px; border-radius:6px;">
              <div class="form-grid-2">
                <div class="field"><label>Tipo <span style="color:#c00">*</span></label>{{ f.tipo }}</div>
                <div class="field"><label>Arquivo <span style="color:#c00">*</span></label>{{ f.arquivo }}</div>
              </div>
              <div class="field" style="margin-top:8px;"><label>Observa√ß√£o</label>{{ f.observacao }}</div>
              {% if f.instance.pk %}<div class="field" style="margin-top:6px;"><label>Excluir</label>{{ f.DELETE }}</div>{% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- FOTOS -->
      {% if fotos_form %}
      <div class="section">
        <h3>Fotos da ocorr√™ncia <small>(at√© 4)</small></h3>
        <div class="field">
          <label>Fotos</label>
          {{ fotos_form.fotos }}
          <div style="margin-top:6px; font-size:0.9rem; color:#555;">
            <span id="foto-counter">0/4 selecionadas</span> ‚Äî formatos aceitos: imagem. As fotos ser√£o otimizadas (1000√ó667, ~103 KB).
          </div>
        </div>
        <div id="preview-grid" class="preview-grid" aria-live="polite"></div>
        <div class="field" style="margin-top:8px;">
          <label>Observa√ß√£o (opcional)</label>
          {{ fotos_form.observacao }}
        </div>
      </div>
      {% endif %}

      <!-- Rodap√© -->
      <div class="form-actions">
        <a href="{% url 'denuncias:listar' %}" class="btn btn-secondary btn-sm">Cancelar</a>
        <button type="submit" class="btn btn-success btn-sm">üìå Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- CSS/JS da app -->
<link rel="stylesheet" href="{% static 'denuncias/css/denuncias.css' %}">
<script src="{% static 'denuncias/js/denuncias.js' %}"></script>
<script src="{% static 'js/viacep.js' %}"></script>

<!-- Estilos locais da galeria -->
<style>
  .preview-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px; margin-top:10px;}
  .preview-item{ border:1px solid #ddd; border-radius:8px; padding:6px; text-align:center; background:#fafafa;}
  .preview-item img{ display:block; width:100%; height:78px; object-fit:cover; border-radius:6px;}
  .preview-name{ margin-top:4px; font-size:.78rem; color:#555; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
</style>

<!-- JS da pr√©-visualiza√ß√£o (cadastro) -->
<script>
(function(){
  const input = document.querySelector('input[name="fotos"]');
  const counter = document.getElementById('foto-counter');
  const grid = document.getElementById('preview-grid');
  const MAX = 4;
  if(!input) return;

  input.setAttribute('accept','image/*');
  input.setAttribute('multiple','multiple');
  input.setAttribute('capture','environment');

  input.addEventListener('change', function(){
    let files = Array.from(input.files||[]);
    if(files.length > MAX){
      const allow = files.slice(0, MAX);
      const dt = new DataTransfer();
      allow.forEach(f=>dt.items.add(f));
      input.files = dt.files;
      files = allow;
      alert(`Permitido no m√°ximo ${MAX}. Mantive os ${MAX} primeiros.`);
    }
    counter.textContent = `${files.length}/${MAX} selecionadas`;
    grid.innerHTML = '';
    files.forEach(f=>{
      const r=new FileReader();
      r.onload=e=>{
        const div=document.createElement('div');
        div.className='preview-item';
        div.innerHTML=`<img src="${e.target.result}" alt="pr√©-visualiza√ß√£o"><div class="preview-name" title="${f.name}">${f.name}</div>`;
        grid.appendChild(div);
      };
      r.readAsDataURL(f);
    });
  });
})();
</script>
<script>
// Copiar endere√ßo do denunciado (alvo) para o Local da Ocorr√™ncia
(function(){
  const btn = document.getElementById('btnCopyEndereco');
  if(!btn) return;
  btn.addEventListener('click', function(){
    const $ = (name)=> document.querySelector(`[name="${name}"]`);
    const map = [
      ['denunciado_res_logradouro','local_oco_logradouro'],
      ['denunciado_res_numero','local_oco_numero'],
      ['denunciado_res_complemento','local_oco_complemento'],
      ['denunciado_res_bairro','local_oco_bairro'],
      ['denunciado_res_cidade','local_oco_cidade'],
      ['denunciado_res_uf','local_oco_uf'],
      ['denunciado_res_cep','local_oco_cep']
    ];
    // Se j√° houver valores no destino, confirma sobreposi√ß√£o
    const hasValues = map.some(([_,dst])=>{ const el=$(dst); return el && (el.value||'').trim().length>0; });
    if(hasValues && !confirm('Substituir o endere√ßo da ocorr√™ncia pelo endere√ßo do denunciado?')) return;
    map.forEach(([src,dst])=>{ const s=$(src), d=$(dst); if(s && d) d.value = s.value; });
  });
})();
</script>
{% endblock %}
