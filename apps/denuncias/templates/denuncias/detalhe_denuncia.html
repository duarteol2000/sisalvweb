{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <style>
    /* Grid para mini formul√°rios de v√≠nculo: labels acima, campos abaixo */
    .detail-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .detail-grid .f{ display:flex; flex-direction:column; }
    .detail-grid .f label{ display:block; font-weight:600; margin-bottom:4px; }
    .detail-grid .f input, .detail-grid .f select, .detail-grid .f textarea{ width:100%; }
    @media (max-width: 1100px){ .detail-grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px){ .detail-grid{ grid-template-columns: 1fr; } }
  </style>

  <!-- Header -->
  <!-- Cabe√ßalho Detalhe -->
  <div class="detail-header">
    <div class="detail-left">
      <h2 class="page-title mb-0">üîé Detalhe da Den√∫ncia</h2>

      <div class="detail-actions">
        <a href="{% url 'denuncias:listar' %}" class="btn btn-sm btn-secondary">‚Üê Voltar</a>
        <a href="{% url 'denuncias:editar_basico' obj.pk %}" class="btn btn-sm btn-success">‚úèÔ∏è Editar (b√°sico)</a>
        <a href="{% url 'denuncias:editar_completo' obj.pk %}" class="btn btn-sm btn-outline-success">üõ†Ô∏è Editar (completo)</a>

        {% if notificacoes and notificacoes|length > 0 %}
          {% with n=notificacoes.0 %}
            <a href="{% url 'notificacoes:detalhe' n.pk %}" class="btn btn-sm btn-primary">üìÑ Ver Notifica√ß√£o</a>
          {% endwith %}
        {% else %}
            <a href="{% url 'notificacoes:from_denuncia' obj.pk %}" class="btn btn-sm btn-primary">üìÑ Gerar Notifica√ß√£o</a>
        {% endif %}

        {% if autos and autos|length > 0 %}
          {% with a=autos.0 %}
            <a href="{% url 'autoinfracao:detalhe' a.pk %}" class="btn btn-sm btn-outline-primary">‚öñÔ∏è Ver Auto de Infra√ß√£o</a>
          {% endwith %}
        {% else %}
            <a href="{% url 'autoinfracao:from_denuncia' obj.pk %}" class="btn btn-sm btn-outline-primary">‚öñÔ∏è Gerar Auto de Infra√ß√£o</a>
        {% endif %}

        <a href="{% url 'denuncias:apontamento_novo' obj.pk %}" class="btn btn-sm btn-outline-info">üì∏ Apontamento de Campo</a>
      </div>
    </div>

  <div class="detail-meta">
      <span class="meta-item">
        <strong>Protocolo:</strong>
        <code class="proto">{{ obj.protocolo }}</code>
      </span>
      <span class="meta-sep">‚Ä¢</span>
      <span class="meta-item">
        <strong>Criada em:</strong> {{ obj.criada_em|date:"d/m/Y H:i" }}
      </span>
      <span class="meta-sep">‚Ä¢</span>
      <span class="meta-item">
        <strong>Status:</strong>
        <span class="badge bg-{% if obj.status == 'ABERTA' %}warning{% elif obj.status == 'ENCERRADA' %}success{% else %}secondary{% endif %}">
          {{ obj.get_status_display }}
        </span>
      </span>
    </div>
  </div>

  <hr class="detail-divider">

  <section class="detail-body">
    <h3>Documentos Relacionados</h3>
    <p>
      <strong>Den√∫ncia:</strong> <code class="proto">{{ obj.protocolo }}</code>
    </p>
    <p>
      <strong>Pessoa vinculada:</strong>
      {% if obj.pessoa %}
        {{ obj.pessoa.nome_razao }} ({{ obj.pessoa.get_tipo_display }})
      {% else %}
        ‚Äî
      {% endif %}
    </p>
    <p>
      <strong>Im√≥vel vinculado:</strong>
      {% if obj.imovel %}
        {{ obj.imovel.logradouro }}{% if obj.imovel.numero %}, {{ obj.imovel.numero }}{% endif %} ‚Äî {{ obj.imovel.bairro }} ‚Äî {{ obj.imovel.cidade }}/{{ obj.imovel.uf }}{% if obj.imovel.inscricao %} ‚Ä¢ Inscri√ß√£o: {{ obj.imovel.inscricao }}{% endif %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
    <p>
      <strong>Notifica√ß√µes:</strong>
      {% if notificacoes %}
        {% for n in notificacoes %}
          <a href="{% url 'notificacoes:detalhe' n.pk %}"><code class="proto">{{ n.protocolo }}</code></a>{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
    <p>
      <strong>Autos de Infra√ß√£o:</strong>
      {% if autos %}
        {% for a in autos %}
          <a href="{% url 'autoinfracao:detalhe' a.pk %}"><code class="proto">{{ a.protocolo }}</code></a>{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
  </section>

  {% if not obj.pessoa or not obj.imovel %}
  <section class="detail-body">
    <h3>Vincular Refer√™ncias</h3>
    <div class="row" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:12px;">
      {% if not obj.pessoa %}
      <div class="card p-2">
        <div class="table-head"><div><strong>Pessoa</strong></div></div>
        <form method="post" action="{% url 'denuncias:vincular_pessoa' obj.pk %}" novalidate>
          {% csrf_token %}
          <div class="detail-grid">
            <div class="f"><label>Tipo</label>
              <select name="tipo" class="form-select form-select-sm">
                <option value="PF">Pessoa F√≠sica</option>
                <option value="PJ">Pessoa Jur√≠dica</option>
              </select>
            </div>
            <div class="f"><label>Nome/Raz√£o</label><input type="text" name="nome_razao" class="form-control form-control-sm" value="{{ obj.nome_razao }}"></div>
            <div class="f"><label>Doc. Tipo</label>
              <select name="doc_tipo" class="form-select form-select-sm">
                <option value="OUTRO">Outro</option>
                <option value="CPF">CPF</option>
                <option value="CNPJ">CNPJ</option>
              </select>
            </div>
            <div class="f"><label>Doc. N√∫mero</label><input type="text" name="doc_num" class="form-control form-control-sm"></div>
            <div class="f"><label>E-mail</label><input type="text" name="email" class="form-control form-control-sm" placeholder="ex.: usuario@dominio.com (opcional)"></div>
            <div class="f"><label>Telefone</label><input type="text" name="telefone" class="form-control form-control-sm"></div>
          </div>
          <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Pessoa</button></div>
        </form>
      </div>
      {% endif %}
      {% if not obj.imovel %}
      <div class="card p-2">
        <div class="table-head"><div><strong>Im√≥vel</strong></div></div>
        <form method="post" action="{% url 'denuncias:vincular_imovel' obj.pk %}" novalidate>
          {% csrf_token %}
          <div class="detail-grid">
            <div class="f"><label>Inscri√ß√£o (opcional)</label><input type="text" name="inscricao" class="form-control form-control-sm"></div>
            <div class="f"><label>Logradouro</label><input type="text" name="logradouro" class="form-control form-control-sm" value="{{ obj.local_oco_logradouro }}"></div>
            <div class="f"><label>N√∫mero</label><input type="text" name="numero" class="form-control form-control-sm" value="{{ obj.local_oco_numero }}"></div>
            <div class="f"><label>Complemento</label><input type="text" name="complemento" class="form-control form-control-sm" value="{{ obj.local_oco_complemento }}"></div>
            <div class="f"><label>Bairro</label><input type="text" name="bairro" class="form-control form-control-sm" value="{{ obj.local_oco_bairro }}"></div>
            <div class="f"><label>Cidade</label><input type="text" name="cidade" class="form-control form-control-sm" value="{{ obj.local_oco_cidade }}"></div>
            <div class="f"><label>UF</label><input type="text" name="uf" class="form-control form-control-sm" value="{{ obj.local_oco_uf }}"></div>
            <div class="f"><label>CEP</label><input type="text" name="cep" class="form-control form-control-sm" value="{{ obj.local_oco_cep }}"></div>
          </div>
          <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Im√≥vel</button></div>
        </form>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}


  <!-- Grid de cart√µes -->
  <div class="row g-3">

    <!-- Galeria de Fotos (unificada) -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="table-head"><div><strong>üì∑ Galeria de Fotos (unificada)</strong></div></div>
        <div class="table-wrap">
          {% if galeria %}
            <div class="anexos-grid">
              {% for g in galeria %}
                <div class="anexo-item">
                  <a href="{{ g.url }}" target="_blank" rel="noopener">
                    <img src="{{ g.url }}" alt="Foto" class="thumb" loading="lazy">
                  </a>
                  <p class="anexo-legenda">
                    <span class="badge bg-secondary">{{ g.label }}</span>
                    {% if g.owner == 'DEN' and g.id %}
                      <a class="btn btn-sm btn-secondary" href="{% url 'denuncias:editar' obj.pk %}?del_anexo={{ g.id }}" onclick="return confirm('Remover esta foto da Den√∫ncia?');" style="margin-left:6px;">Excluir</a>
                    {% endif %}
                  </p>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <em>Nenhuma foto para exibir.</em>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Apontamentos de Campo -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Apontamentos de Campo</strong></div>
        <div class="card-body">
          {% if apontamentos %}
          <div class="row" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px;">
            {% for ap in apontamentos %}
              <div class="p-2" style="border:1px solid #e5e7eb; border-radius:8px;">
                <div class="small text-muted">{{ ap.criado_em|date:"d/m/Y H:i" }} ‚Äî {% with u=ap.criado_por %}{% if u %}{{ u.get_full_name|default:u.email }}{% else %}‚Äî{% endif %}{% endwith %}</div>
                {% if ap.observacao %}<div style="margin-top:4px; white-space:pre-line;">{{ ap.observacao }}</div>{% endif %}
                {% if ap.anexos.all %}
                  <div class="mt-2" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px;">
                    {% for ax in ap.anexos.all %}
                      <a href="{{ ax.arquivo.url }}" target="_blank" rel="noopener">
                        <img src="{{ ax.arquivo.url }}" alt="Foto" style="width:100%; height:80px; object-fit:cover; border-radius:6px;" />
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% else %}
            <em>Nenhum apontamento cadastrado.</em>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Situa√ß√£o -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Situa√ß√£o</strong></div>
        <div class="card-body">
          <div class="row align-items-end">
            <div class="col-md-4">
              <small class="text-muted d-block">Proced√™ncia:</small>
              {% if notificacoes or autos %}
                <div>{{ obj.get_procedencia_display }} <span class="hint">(bloqueado: j√° possui NTF/AIF)</span></div>
              {% else %}
                <form method="post" action="{% url 'denuncias:set_procedencia' obj.pk %}" class="d-flex" style="gap:8px; align-items:center;">
                  {% csrf_token %}
                  <select name="procedencia" class="form-select form-select-sm" style="max-width:220px;">
                    <option value="PROCEDE" {% if obj.procedencia == 'PROCEDE' %}selected{% endif %}>Procede</option>
                    <option value="NAO_PROCEDE" {% if obj.procedencia == 'NAO_PROCEDE' %}selected{% endif %}>N√£o procede</option>
                  </select>
                  <button class="btn btn-sm btn-primary">Atualizar</button>
                </form>
              {% endif %}
            </div>
            <div class="col-md-3"><small class="text-muted d-block">Origem:  </small>{{ obj.get_origem_denuncia_display }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Ativo?       </small>{{ obj.ativo|yesno:"Sim,N√£o" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Canal:  </small>{{ obj.get_canal_registro_display }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Denunciado (alvo) -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Denunciado (alvo)</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4"><small class="text-muted d-block">Tipo de pessoa:  </small>{{ obj.get_denunciado_tipo_pessoa_display }}</div>
            <div class="col-md-8"><small class="text-muted d-block">Nome / Raz√£o Social:  </small>{{ obj.denunciado_nome_razao }}</div>
          </div>
          <div class="row mt-2">
            <div class="col-md-3"><small class="text-muted d-block">CPF/CNPJ:  </small>{{ obj.denunciado_cpf_cnpj }}</div>
            <div class="col-md-3"><small class="text-muted d-block">RG/IE:  </small>{{ obj.denunciado_rg_ie }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Telefone:  </small>{{ obj.denunciado_telefone }}</div>
            <div class="col-md-3"><small class="text-muted d-block">E-mail:  </small>{{ obj.denunciado_email }}</div>
          </div>

          <hr class="my-3">

          <div class="row">
            <div class="col-md-12"><small class="text-muted d-block">Endere√ßo Residencial:  </small>
              {{ obj.denunciado_res_logradouro }}
              {% if obj.denunciado_res_numero %}, {{ obj.denunciado_res_numero }}{% endif %}
              {% if obj.denunciado_res_complemento %} ‚Äî {{ obj.denunciado_res_complemento }}{% endif %}
              {% if obj.denunciado_res_bairro %} ‚Äî {{ obj.denunciado_res_bairro }}{% endif %}
              {% if obj.denunciado_res_cidade %} ‚Äî {{ obj.denunciado_res_cidade }}{% endif %}
              {% if obj.denunciado_res_uf %}/{{ obj.denunciado_res_uf }}{% endif %}
              {% if obj.denunciado_res_cep %} ‚Ä¢ CEP: {{ obj.denunciado_res_cep }}{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Denunciante -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Denunciante</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3"><small class="text-muted d-block">An√¥nima?  </small>{{ obj.denunciante_anonimo|yesno:"Sim,N√£o" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Nome:  </small>{{ obj.denunciante_nome }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Telefone:  </small>{{ obj.denunciante_telefone }}</div>
            <div class="col-md-3"><small class="text-muted d-block">E-mail:  </small>{{ obj.denunciante_email }}</div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4"><small class="text-muted d-block">Fiscal denunciante:  </small>{{ obj.denunciante_fiscal }}</div>
            <div class="col-md-8"><small class="text-muted d-block">Fiscais que atenderam:  </small>
              {% if obj.fiscais.all %}
                {% for f in obj.fiscais.all %}{{ f.get_full_name|default:f.username }}{% if not forloop.last %}, {% endif %}{% endfor %}
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Local da ocorr√™ncia -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Local da Ocorr√™ncia  </strong></div>
        <div class="card-body">
          <div class="mb-2"><small class="text-muted d-block">Endere√ßo:  </small>{{ endereco_oco }}</div>
          <div class="row">
            <div class="col-md-3"><small class="text-muted d-block">Latitude:  </small>{{ obj.local_oco_lat }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Longitude:  </small>{{ obj.local_oco_lng }}</div>
            <div class="col-md-6"><small class="text-muted d-block">Descri√ß√£o:  </small><div>{{ obj.descricao_oco|linebreaksbr }}</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Auditoria -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Auditoria</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3"><small class="text-muted d-block">Criado por:  </small>{{ obj.criado_por|default:"‚Äî" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Atualizado em:  </small>{{ obj.atualizada_em|date:"d/m/Y H:i" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">IP de origem:  </small>{{ obj.ip_origem|default:"‚Äî" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">User-Agent:  </small><span class="text-break">{{ obj.user_agent|default:"‚Äî" }}</span></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /row -->

  <!-- Ficha Completa -->
  <div class="card shadow-sm" style="margin-top:10px;">
    <div class="card-header bg-light"><strong>üìë Ficha Completa</strong></div>
    <div class="card-body">
      <div class="detail-grid">
        <!-- Situa√ß√£o geral -->
        <div class="f"><label>Protocolo</label><div>{{ obj.protocolo }}</div></div>
        <div class="f"><label>Status</label><div>{{ obj.get_status_display }}</div></div>
        <div class="f"><label>Proced√™ncia</label><div>{{ obj.get_procedencia_display }}</div></div>
        <div class="f"><label>Ativo?</label><div>{{ obj.ativo|yesno:"Sim,N√£o" }}</div></div>
        <div class="f"><label>Canal de Registro</label><div>{{ obj.get_canal_registro_display }}</div></div>

        <!-- Denunciado (alvo) -->
        <div class="f"><label>Tipo Pessoa (Alvo)</label><div>{{ obj.get_denunciado_tipo_pessoa_display }}</div></div>
        <div class="f"><label>Nome/Raz√£o (Alvo)</label><div>{{ obj.denunciado_nome_razao }}</div></div>
        <div class="f"><label>CPF/CNPJ (Alvo)</label><div>{{ obj.denunciado_cpf_cnpj|default:"‚Äî" }}</div></div>
        <div class="f"><label>RG/IE (Alvo)</label><div>{{ obj.denunciado_rg_ie|default:"‚Äî" }}</div></div>
        <div class="f"><label>Telefone (Alvo)</label><div>{{ obj.denunciado_telefone|default:"‚Äî" }}</div></div>
        <div class="f"><label>E-mail (Alvo)</label><div>{{ obj.denunciado_email|default:"‚Äî" }}</div></div>

        <!-- Endere√ßo residencial do alvo -->
        <div class="f"><label>Logradouro (Res.)</label><div>{{ obj.denunciado_res_logradouro|default:"‚Äî" }}</div></div>
        <div class="f"><label>N√∫mero (Res.)</label><div>{{ obj.denunciado_res_numero|default:"‚Äî" }}</div></div>
        <div class="f"><label>Complemento (Res.)</label><div>{{ obj.denunciado_res_complemento|default:"‚Äî" }}</div></div>
        <div class="f"><label>Bairro (Res.)</label><div>{{ obj.denunciado_res_bairro|default:"‚Äî" }}</div></div>
        <div class="f"><label>Cidade (Res.)</label><div>{{ obj.denunciado_res_cidade|default:"‚Äî" }}</div></div>
        <div class="f"><label>UF (Res.)</label><div>{{ obj.denunciado_res_uf|default:"‚Äî" }}</div></div>
        <div class="f"><label>CEP (Res.)</label><div>{{ obj.denunciado_res_cep|default:"‚Äî" }}</div></div>

        <!-- Denunciante -->
        <div class="f"><label>Den√∫ncia An√¥nima?</label><div>{{ obj.denunciante_anonimo|yesno:"Sim,N√£o" }}</div></div>
        <div class="f"><label>Denunciante (Nome)</label><div>{{ obj.denunciante_nome|default:"‚Äî" }}</div></div>
        <div class="f"><label>Denunciante (Telefone)</label><div>{{ obj.denunciante_telefone|default:"‚Äî" }}</div></div>
        <div class="f"><label>Denunciante (E-mail)</label><div>{{ obj.denunciante_email|default:"‚Äî" }}</div></div>
        <div class="f"><label>Fiscal Denunciante</label><div>{{ obj.denunciante_fiscal|default:"‚Äî" }}</div></div>

        <!-- Local da Ocorr√™ncia -->
        <div class="f"><label>Logradouro (Ocorr√™ncia)</label><div>{{ obj.local_oco_logradouro }}</div></div>
        <div class="f"><label>N¬∫ / Lote / Quadra</label><div>{{ obj.local_oco_numero|default:"‚Äî" }}</div></div>
        <div class="f"><label>Complemento</label><div>{{ obj.local_oco_complemento|default:"‚Äî" }}</div></div>
        <div class="f"><label>Ponto de Refer√™ncia</label><div>{{ obj.local_oco_pontoref|default:"‚Äî" }}</div></div>
        <div class="f"><label>Bairro (Ocorr√™ncia)</label><div>{{ obj.local_oco_bairro }}</div></div>
        <div class="f"><label>Cidade (Ocorr√™ncia)</label><div>{{ obj.local_oco_cidade }}</div></div>
        <div class="f"><label>UF (Ocorr√™ncia)</label><div>{{ obj.local_oco_uf }}</div></div>
        <div class="f"><label>CEP (Ocorr√™ncia)</label><div>{{ obj.local_oco_cep|default:"‚Äî" }}</div></div>
        <div class="f"><label>Latitude</label><div>{{ obj.local_oco_lat|default:"‚Äî" }}</div></div>
        <div class="f"><label>Longitude</label><div>{{ obj.local_oco_lng|default:"‚Äî" }}</div></div>
        <div class="f span-3"><label>Descri√ß√£o da Ocorr√™ncia</label><div style="white-space:pre-line;">{{ obj.descricao_oco }}</div></div>

        <!-- Auditoria -->
        <div class="f"><label>Criada em</label><div>{{ obj.criada_em|date:"d/m/Y H:i" }}</div></div>
        <div class="f"><label>Atualizada em</label><div>{{ obj.atualizada_em|date:"d/m/Y H:i" }}</div></div>
        <div class="f"><label>Criado por</label><div>{{ obj.criado_por|default:"‚Äî" }}</div></div>
        <div class="f"><label>IP de Origem</label><div>{{ obj.ip_origem|default:"‚Äî" }}</div></div>
        <div class="f span-3"><label>User-Agent</label><div class="text-break">{{ obj.user_agent|default:"‚Äî" }}</div></div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
