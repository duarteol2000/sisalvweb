{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <style>
    /* Grid para mini formul√°rios de v√≠nculo: labels acima, campos abaixo */
    .detail-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .detail-grid .f{ display:flex; flex-direction:column; }
    .detail-grid .f label{ display:block; font-weight:600; margin-bottom:4px; }
    .detail-grid .f input, .detail-grid .f select, .detail-grid .f textarea{ width:100%; }
    @media (max-width: 1100px){ .detail-grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px){ .detail-grid{ grid-template-columns: 1fr; } }
  </style>

  <!-- Header -->
  <!-- Cabe√ßalho Detalhe -->
  <div class="detail-header">
    <div class="detail-left">
      <h2 class="page-title mb-0">üîé Detalhe da Den√∫ncia</h2>

      <div class="detail-actions">
        <a href="{% url 'denuncias:listar' %}" class="btn btn-sm btn-secondary">‚Üê Voltar</a>
        <a href="{% url 'denuncias:editar_basico' obj.pk %}" class="btn btn-sm btn-success">‚úèÔ∏è Editar (b√°sico)</a>
        <a href="{% url 'notificacoes:from_denuncia' obj.pk %}" class="btn btn-sm btn-primary">üìÑ Gerar Notifica√ß√£o</a>
        <a href="{% url 'autoinfracao:from_denuncia' obj.pk %}" class="btn btn-sm btn-outline-primary">‚öñÔ∏è Gerar Auto de Infra√ß√£o</a>
      </div>
    </div>

  <div class="detail-meta">
      <span class="meta-item">
        <strong>Protocolo:</strong>
        <code class="proto">{{ obj.protocolo }}</code>
      </span>
      <span class="meta-sep">‚Ä¢</span>
      <span class="meta-item">
        <strong>Criada em:</strong> {{ obj.criada_em|date:"d/m/Y H:i" }}
      </span>
      <span class="meta-sep">‚Ä¢</span>
      <span class="meta-item">
        <strong>Status:</strong>
        <span class="badge bg-{% if obj.status == 'ABERTA' %}warning{% elif obj.status == 'ENCERRADA' %}success{% else %}secondary{% endif %}">
          {{ obj.get_status_display }}
        </span>
      </span>
    </div>
  </div>

  <hr class="detail-divider">

  <section class="detail-body">
    <h3>Documentos Relacionados</h3>
    <p>
      <strong>Den√∫ncia:</strong> <code class="proto">{{ obj.protocolo }}</code>
    </p>
    <p>
      <strong>Pessoa vinculada:</strong>
      {% if obj.pessoa %}
        {{ obj.pessoa.nome_razao }} ({{ obj.pessoa.get_tipo_display }})
      {% else %}
        ‚Äî
      {% endif %}
    </p>
    <p>
      <strong>Im√≥vel vinculado:</strong>
      {% if obj.imovel %}
        {{ obj.imovel.logradouro }}{% if obj.imovel.numero %}, {{ obj.imovel.numero }}{% endif %} ‚Äî {{ obj.imovel.bairro }} ‚Äî {{ obj.imovel.cidade }}/{{ obj.imovel.uf }}{% if obj.imovel.inscricao %} ‚Ä¢ Inscri√ß√£o: {{ obj.imovel.inscricao }}{% endif %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
    <p>
      <strong>Notifica√ß√µes:</strong>
      {% if notificacoes %}
        {% for n in notificacoes %}
          <a href="{% url 'notificacoes:detalhe' n.pk %}"><code class="proto">{{ n.protocolo }}</code></a>{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
    <p>
      <strong>Autos de Infra√ß√£o:</strong>
      {% if autos %}
        {% for a in autos %}
          <a href="{% url 'autoinfracao:detalhe' a.pk %}"><code class="proto">{{ a.protocolo }}</code></a>{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
  </section>

  {% if not obj.pessoa or not obj.imovel %}
  <section class="detail-body">
    <h3>Vincular Refer√™ncias</h3>
    <div class="row" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:12px;">
      {% if not obj.pessoa %}
      <div class="card p-2">
        <div class="table-head"><div><strong>Pessoa</strong></div></div>
        <form method="post" action="{% url 'denuncias:vincular_pessoa' obj.pk %}">
          {% csrf_token %}
          <div class="detail-grid">
            <div class="f"><label>Tipo</label>
              <select name="tipo" class="form-select form-select-sm">
                <option value="PF">Pessoa F√≠sica</option>
                <option value="PJ">Pessoa Jur√≠dica</option>
              </select>
            </div>
            <div class="f"><label>Nome/Raz√£o</label><input type="text" name="nome_razao" class="form-control form-control-sm" value="{{ obj.nome_razao }}"></div>
            <div class="f"><label>Doc. Tipo</label>
              <select name="doc_tipo" class="form-select form-select-sm">
                <option value="OUTRO">Outro</option>
                <option value="CPF">CPF</option>
                <option value="CNPJ">CNPJ</option>
              </select>
            </div>
            <div class="f"><label>Doc. N√∫mero</label><input type="text" name="doc_num" class="form-control form-control-sm"></div>
            <div class="f"><label>E-mail</label><input type="email" name="email" class="form-control form-control-sm"></div>
            <div class="f"><label>Telefone</label><input type="text" name="telefone" class="form-control form-control-sm"></div>
          </div>
          <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Pessoa</button></div>
        </form>
      </div>
      {% endif %}
      {% if not obj.imovel %}
      <div class="card p-2">
        <div class="table-head"><div><strong>Im√≥vel</strong></div></div>
        <form method="post" action="{% url 'denuncias:vincular_imovel' obj.pk %}">
          {% csrf_token %}
          <div class="detail-grid">
            <div class="f"><label>Inscri√ß√£o (opcional)</label><input type="text" name="inscricao" class="form-control form-control-sm"></div>
            <div class="f"><label>Logradouro</label><input type="text" name="logradouro" class="form-control form-control-sm" value="{{ obj.local_oco_logradouro }}"></div>
            <div class="f"><label>N√∫mero</label><input type="text" name="numero" class="form-control form-control-sm" value="{{ obj.local_oco_numero }}"></div>
            <div class="f"><label>Complemento</label><input type="text" name="complemento" class="form-control form-control-sm" value="{{ obj.local_oco_complemento }}"></div>
            <div class="f"><label>Bairro</label><input type="text" name="bairro" class="form-control form-control-sm" value="{{ obj.local_oco_bairro }}"></div>
            <div class="f"><label>Cidade</label><input type="text" name="cidade" class="form-control form-control-sm" value="{{ obj.local_oco_cidade }}"></div>
            <div class="f"><label>UF</label><input type="text" name="uf" class="form-control form-control-sm" value="{{ obj.local_oco_uf }}"></div>
            <div class="f"><label>CEP</label><input type="text" name="cep" class="form-control form-control-sm" value="{{ obj.local_oco_cep }}"></div>
          </div>
          <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Im√≥vel</button></div>
        </form>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}


  <!-- Grid de cart√µes -->
  <div class="row g-3">

    <!-- Situa√ß√£o -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Situa√ß√£o</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3"><small class="text-muted d-block">Proced√™ncia:  </small>{{ obj.get_procedencia_display }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Origem:  </small>{{ obj.get_origem_denuncia_display }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Ativo?       </small>{{ obj.ativo|yesno:"Sim,N√£o" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Canal:  </small>{{ obj.get_canal_registro_display }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Denunciado (alvo) -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Denunciado (alvo)</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4"><small class="text-muted d-block">Tipo de pessoa:  </small>{{ obj.get_denunciado_tipo_pessoa_display }}</div>
            <div class="col-md-8"><small class="text-muted d-block">Nome / Raz√£o Social:  </small>{{ obj.denunciado_nome_razao }}</div>
          </div>
          <div class="row mt-2">
            <div class="col-md-3"><small class="text-muted d-block">CPF/CNPJ:  </small>{{ obj.denunciado_cpf_cnpj }}</div>
            <div class="col-md-3"><small class="text-muted d-block">RG/IE:  </small>{{ obj.denunciado_rg_ie }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Telefone:  </small>{{ obj.denunciado_telefone }}</div>
            <div class="col-md-3"><small class="text-muted d-block">E-mail:  </small>{{ obj.denunciado_email }}</div>
          </div>

          <hr class="my-3">

          <div class="row">
            <div class="col-md-12"><small class="text-muted d-block">Endere√ßo Residencial:  </small>
              {{ obj.denunciado_res_logradouro }}
              {% if obj.denunciado_res_numero %}, {{ obj.denunciado_res_numero }}{% endif %}
              {% if obj.denunciado_res_complemento %} ‚Äî {{ obj.denunciado_res_complemento }}{% endif %}
              {% if obj.denunciado_res_bairro %} ‚Äî {{ obj.denunciado_res_bairro }}{% endif %}
              {% if obj.denunciado_res_cidade %} ‚Äî {{ obj.denunciado_res_cidade }}{% endif %}
              {% if obj.denunciado_res_uf %}/{{ obj.denunciado_res_uf }}{% endif %}
              {% if obj.denunciado_res_cep %} ‚Ä¢ CEP: {{ obj.denunciado_res_cep }}{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Denunciante -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Denunciante</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3"><small class="text-muted d-block">An√¥nima?  </small>{{ obj.denunciante_anonimo|yesno:"Sim,N√£o" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Nome:  </small>{{ obj.denunciante_nome }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Telefone:  </small>{{ obj.denunciante_telefone }}</div>
            <div class="col-md-3"><small class="text-muted d-block">E-mail:  </small>{{ obj.denunciante_email }}</div>
          </div>
          <div class="row mt-2">
            <div class="col-md-4"><small class="text-muted d-block">Fiscal denunciante:  </small>{{ obj.denunciante_fiscal }}</div>
            <div class="col-md-8"><small class="text-muted d-block">Fiscais que atenderam:  </small>
              {% if obj.fiscais.all %}
                {% for f in obj.fiscais.all %}{{ f.get_full_name|default:f.username }}{% if not forloop.last %}, {% endif %}{% endfor %}
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Local da ocorr√™ncia -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Local da Ocorr√™ncia  </strong></div>
        <div class="card-body">
          <div class="mb-2"><small class="text-muted d-block">Endere√ßo:  </small>{{ endereco_oco }}</div>
          <div class="row">
            <div class="col-md-3"><small class="text-muted d-block">Latitude:  </small>{{ obj.local_oco_lat }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Longitude:  </small>{{ obj.local_oco_lng }}</div>
            <div class="col-md-6"><small class="text-muted d-block">Descri√ß√£o:  </small><div>{{ obj.descricao_oco|linebreaksbr }}</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Auditoria -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light"><strong>Auditoria</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3"><small class="text-muted d-block">Criado por:  </small>{{ obj.criado_por|default:"‚Äî" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">Atualizado em:  </small>{{ obj.atualizada_em|date:"d/m/Y H:i" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">IP de origem:  </small>{{ obj.ip_origem|default:"‚Äî" }}</div>
            <div class="col-md-3"><small class="text-muted d-block">User-Agent:  </small><span class="text-break">{{ obj.user_agent|default:"‚Äî" }}</span></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /row -->

</div>
{% endblock %}
