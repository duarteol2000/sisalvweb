{% extends "core/base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'autoinfracao/css/autoinfracao.css' %}">
<link rel="stylesheet" href="{% static 'vendor/leaflet/leaflet.css' %}">
<style>#map-pick{height:260px;min-height:220px}.leaflet-container img{max-width:none!important}</style>
{% endblock %}
{% block menu_autoinfracao_active %}active{% endblock %}
{% block content %}

<h2 class="page-title">üÜï Novo Auto de Infra√ß√£o ‚Äî Dados B√°sicos</h2>
<a href="{% url 'autoinfracao:listar' %}" class="btn btn-sm btn-secondary">‚Üê Voltar para a Listagem</a>

<form method="post" enctype="multipart/form-data" class="notificacao-form">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div class="form-grid">
    <h3 class="span-3">Dados Pessoais</h3>
    <div>
      {{ form.pessoa_tipo.label_tag }}
      {{ form.pessoa_tipo }}
      {{ form.pessoa_tipo.errors }}
    </div>
    <div>
      {{ form.nome_razao.label_tag }}
      {{ form.nome_razao }}
      {{ form.nome_razao.errors }}
    </div>
    <div>
      {{ form.cpf_cnpj.label_tag }}
      {{ form.cpf_cnpj }}
      {{ form.cpf_cnpj.errors }}
    </div>
    <div>
      {{ form.rg.label_tag }}
      {{ form.rg }}
      {{ form.rg.errors }}
    </div>
    <div>
      {{ form.telefone.label_tag }}
      {{ form.telefone }}
      {{ form.telefone.errors }}
    </div>
    <div>
      {{ form.email.label_tag }}
      {{ form.email }}
      {{ form.email.errors }}
    </div>

    <hr class="span-3">
    <h3 class="span-3">Local da Ocorr√™ncia</h3>
    <div>
      {{ form.cep.label_tag }}
      {{ form.cep }}
      {{ form.cep.errors }}
    </div>
    <div>
      {{ form.logradouro.label_tag }}
      {{ form.logradouro }}
      {{ form.logradouro.errors }}
    </div>
    <div>
      {{ form.numero.label_tag }}
      {{ form.numero }}
      {{ form.numero.errors }}
    </div>
    <div>
      {{ form.complemento.label_tag }}
      {{ form.complemento }}
      {{ form.complemento.errors }}
    </div>
    <div>
      {{ form.bairro.label_tag }}
      {{ form.bairro }}
      {{ form.bairro.errors }}
    </div>
    <div>
      {{ form.cidade.label_tag }}
      {{ form.cidade }}
      {{ form.cidade.errors }}
    </div>
    <div>
      {{ form.uf.label_tag }}
      {{ form.uf }}
      {{ form.uf.errors }}
    </div>

    <div>
      {{ form.latitude.label_tag }}
      {{ form.latitude }}
      {{ form.latitude.errors }}
    </div>
    <div>
      {{ form.longitude.label_tag }}
      {{ form.longitude }}
      {{ form.longitude.errors }}
    </div>
    <div class="span-3">
      <label><strong>Mapa (clique para preencher lat/lng)</strong></label>
      <div id="map-pick"></div>
      <small>Clique no ponto exato do local.</small>
    </div>

    <hr class="span-3">
    <h3 class="span-3">Caracter√≠sticas da Edifica√ß√£o</h3>
    <div>
      {{ form.area_m2.label_tag }}
      {{ form.area_m2 }}
      {{ form.area_m2.errors }}
    </div>
    <div>
      {{ form.testada_m.label_tag }}
      {{ form.testada_m }}
      {{ form.testada_m.errors }}
    </div>
    <div>
      {{ form.pe_direito_m.label_tag }}
      {{ form.pe_direito_m }}
      {{ form.pe_direito_m.errors }}
    </div>
    <div>
      {{ form.duplex.label_tag }}
      {{ form.duplex }}
      {{ form.duplex.errors }}
    </div>
    <div>
      {{ form.qtd_comodos.label_tag }}
      {{ form.qtd_comodos }}
      {{ form.qtd_comodos.errors }}
    </div>
    <div>
      {{ form.compartimentacao.label_tag }}
      {{ form.compartimentacao }}
      {{ form.compartimentacao.errors }}
    </div>
    <div>
      {{ form.divisorias.label_tag }}
      {{ form.divisorias }}
      {{ form.divisorias.errors }}
    </div>
    <div>
      {{ form.mezanino.label_tag }}
      {{ form.mezanino }}
      {{ form.mezanino.errors }}
    </div>
    <div>
      {{ form.area_mezanino_m2.label_tag }}
      {{ form.area_mezanino_m2 }}
      {{ form.area_mezanino_m2.errors }}
    </div>

    <hr class="span-3">
    <h3 class="span-3">Dados do Auto</h3>
    <div class="span-3">
      {{ form.descricao.label_tag }}
      {{ form.descricao }}
      {{ form.descricao.errors }}
    </div>

    <div class="span-3">
      <label>Tipos de Infra√ß√£o</label>
      <div class="checkbox-grid">
        {% for t in form.tipos.field.queryset %}
          <label>
            <input type="checkbox" name="tipos" value="{{ t.id }}">
            {{ t.nome }}
          </label>
        {% empty %}
          <em>Nenhum tipo dispon√≠vel.</em>
        {% endfor %}
      </div>
      <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
        <a href="{% url 'autoinfracao:tipos_novo' %}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">+ Novo Tipo de Infra√ß√£o</a>
        <a href="{% url 'autoinfracao:tipos_listar' %}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">Gerenciar</a>
      </div>
    </div>

    <div class="span-3">
      <label for="id_fiscais">Fiscais</label>
      {{ form.fiscais }}
    </div>
  </div>

  <hr>
  <h3>üìé Fotos do Auto</h3>
  <div class="form-grid">
    <div>
      <label for="id_fotos">Selecionar fotos</label>
      <input id="id_fotos" type="file" name="fotos" multiple accept="image/*">
      <small>Voc√™ pode selecionar v√°rias imagens.</small>
    </div>
  </div>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary">Salvar</button>
  </div>
</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/viacep.js' %}"></script>
<script src="{% static 'vendor/leaflet/leaflet.js' %}"></script>
<script src="{% static 'autoinfracao/js/autoinfracao.js' %}?v=20251030-1"></script>
<script>
(function(){
  const latI = document.getElementById('id_latitude');
  const lngI = document.getElementById('id_longitude');
  const mapEl = document.getElementById('map-pick');
  if(!mapEl || !window.L) return;
  function parseNum(v){ if(v==null||v==='') return null; v=(v+'').replace(',', '.'); var n=parseFloat(v); return isNaN(n)?null:n; }
  let lat = parseNum(latI.value), lng = parseNum(lngI.value);
  if(lat==null || lng==null){ lat = -3.7327; lng = -38.5270; }
  const map = L.map('map-pick'); map.setView([lat,lng], latI.value&&lngI.value?17:13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
  let mark = L.marker([lat,lng], {draggable:true}).addTo(map);
  mark.on('dragend', () => { const p = mark.getLatLng(); latI.value=p.lat.toFixed(6); lngI.value=p.lng.toFixed(6); });
  map.on('click', e=>{ const p = e.latlng; mark.setLatLng(p); latI.value=p.lat.toFixed(6); lngI.value=p.lng.toFixed(6); });
  latI.addEventListener('change', ()=>{ const a=parseNum(latI.value), b=parseNum(lngI.value); if(a!=null&&b!=null){ mark.setLatLng([a,b]); map.setView([a,b], 17);} });
  lngI.addEventListener('change', ()=>{ const a=parseNum(latI.value), b=parseNum(lngI.value); if(a!=null&&b!=null){ mark.setLatLng([a,b]); map.setView([a,b], 17);} });
  setTimeout(()=> map.invalidateSize(), 50);
})();
</script>
{% endblock %}
