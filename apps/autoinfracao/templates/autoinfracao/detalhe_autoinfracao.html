{% extends "core/base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'autoinfracao/css/autoinfracao.css' %}">
<style>
  .link-ver{ font-size:.85rem; color: var(--muted); text-decoration:none; margin-left:6px; }
  .link-ver:hover{ color: var(--accent); text-decoration: underline; }
  .doc-rel strong{ margin-right:6px; }
  .doc-rel code.proto{ margin-right:6px; }
  /* Grid para mini formul√°rios de v√≠nculo: labels acima, campos abaixo */
  .detail-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
  .detail-grid .f{ display:flex; flex-direction:column; }
  .detail-grid .f label{ display:block; font-weight:600; margin-bottom:4px; }
  .detail-grid .f input, .detail-grid .f select, .detail-grid .f textarea{ width:100%; }
  @media (max-width: 1100px){ .detail-grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 700px){ .detail-grid{ grid-template-columns: 1fr; } }
</style>
{% endblock %}
{% block menu_autoinfracao_active %}active{% endblock %}
{% block content %}

<header class="detail-header">
  <div class="left">
    <h1 class="page-title">üîé Detalhe do Auto de Infra√ß√£o</h1>
    <div class="actions">
      <a href="{% url 'autoinfracao:listar' %}" class="btn btn-sm btn-secondary">‚Üê Voltar</a>
      <a href="{% url 'autoinfracao:editar' obj.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
      <a href="{% url 'autoinfracao:imprimir' obj.pk %}" class="btn btn-sm btn-secondary" target="_blank" rel="noopener">Imprimir</a>
      {% if obj.status != 'REGULARIZADO' %}
        <a href="{% url 'autoinfracao:gerar_embargo' obj.pk %}" class="btn btn-sm btn-outline-primary">‚õî Gerar Embargo</a>
        <a href="{% url 'autoinfracao:gerar_interdicao' obj.pk %}" class="btn btn-sm btn-outline-primary">üö´ Gerar Interdi√ß√£o</a>
      {% endif %}
    </div>
  </div>
  <div class="right detail-meta">
    <div><strong>Protocolo:</strong> <code class="proto">{{ obj.protocolo }}</code></div>
    <div><strong>Status:</strong> {{ obj.get_status_display }}</div>
    <div><strong>Criado em:</strong> {{ obj.criada_em|date:"d/m/Y H:i" }}</div>
    <div><strong>Val. Infra√ß√£o (AIF):</strong> R$ {{ obj.valor_infracao|default:obj.total_infracao_itens|floatformat:2 }}</div>
    <div><strong>Val. Homologado (AIF):</strong> R$ {{ obj.valor_multa_homologado|default:obj.total_multa|floatformat:2 }}</div>
    <div>
      <strong>Pagamento:</strong>
      {% if obj.pago %}
        ‚úÖ Pago ‚Äî R$ {{ obj.valor_pago|default:obj.valor_multa_homologado|floatformat:2 }}
        {% if obj.pago_em %} em {{ obj.pago_em|date:"d/m/Y" }}{% endif %}
        {% if obj.forma_pagamento %} ({{ obj.get_forma_pagamento_display }}){% endif %}
        {% if obj.guia_numero %} ‚Äî Guia: {{ obj.guia_numero }}{% endif %}
      {% else %}
        ‚ùå N√£o pago
      {% endif %}
    </div>
  </div>
</header>

<section class="detail-body">
  <h3>Documentos Relacionados</h3>
  <p class="doc-rel">
    <strong>Den√∫ncia:</strong>
    {% if obj.denuncia %}
      <code class="proto">{{ obj.denuncia.protocolo }}</code>- <a class="link-ver" href="{% url 'denuncias:detalhe' obj.denuncia.pk %}">+ver</a>
    {% else %}
      ‚Äî
    {% endif %}
  </p>
  <p class="doc-rel">
    <strong>Notifica√ß√£o:</strong>
    {% if obj.notificacao %}
      <code class="proto">{{ obj.notificacao.protocolo }}</code>- <a class="link-ver" href="{% url 'notificacoes:detalhe' obj.notificacao.pk %}">+ver</a>
    {% else %}
      ‚Äî
    {% endif %}
  </p>
  <p class="doc-rel">
    <strong>Pessoa vinculada:</strong>
    {% if obj.pessoa %}{{ obj.pessoa.nome_razao }} ({{ obj.pessoa.get_tipo_display }}){% else %}‚Äî{% endif %}
  </p>
  <p class="doc-rel">
    <strong>Im√≥vel vinculado:</strong>
    {% if obj.imovel %}{{ obj.imovel.logradouro }}{% if obj.imovel.numero %}, {{ obj.imovel.numero }}{% endif %} ‚Äî {{ obj.imovel.bairro }} ‚Äî {{ obj.imovel.cidade }}/{{ obj.imovel.uf }}{% if obj.imovel.inscricao %} ‚Ä¢ Inscri√ß√£o: {{ obj.imovel.inscricao }}{% endif %}{% else %}‚Äî{% endif %}
  </p>
  <p>
    <strong>Auto de Infra√ß√£o:</strong>
    <code class="proto">{{ obj.protocolo }}</code>
  </p>
  {% if not obj.pessoa or not obj.imovel %}
  <div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
    <div class="table-head"><div><strong>Vincular Refer√™ncias</strong></div></div>
    <div class="table-wrap">
      <div class="detail-grid">
        {% if not obj.pessoa %}
        <form method="post" action="{% url 'autoinfracao:vincular_pessoa' obj.pk %}" novalidate>
          {% csrf_token %}
          <div class="detail-grid">
            <div class="f"><label>Tipo</label><select name="tipo" class="form-select form-select-sm"><option value="PF">PF</option><option value="PJ">PJ</option></select></div>
            <div class="f"><label>Nome/Raz√£o</label><input type="text" name="nome_razao" class="form-control form-control-sm" value="{{ obj.nome_razao }}"></div>
            <div class="f"><label>Doc. Tipo</label><select name="doc_tipo" class="form-select form-select-sm"><option value="OUTRO">Outro</option><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select></div>
            <div class="f"><label>Doc. N√∫mero</label><input type="text" name="doc_num" class="form-control form-control-sm" value="{{ obj.cpf_cnpj }}"></div>
            <div class="f"><label>E-mail</label><input type="text" name="email" class="form-control form-control-sm" value="{{ obj.email }}" placeholder="ex.: usuario@dominio.com (opcional)"></div>
            <div class="f"><label>Telefone</label><input type="text" name="telefone" class="form-control form-control-sm" value="{{ obj.telefone }}"></div>
          </div>
          <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Pessoa</button></div>
        </form>
        {% endif %}
        {% if not obj.imovel %}
        <form method="post" action="{% url 'autoinfracao:vincular_imovel' obj.pk %}" novalidate>
          {% csrf_token %}
          <div class="detail-grid">
            <div class="f"><label>Inscri√ß√£o</label><input type="text" name="inscricao" class="form-control form-control-sm"></div>
            <div class="f"><label>Logradouro</label><input type="text" name="logradouro" class="form-control form-control-sm" value="{{ obj.logradouro }}"></div>
            <div class="f"><label>N√∫mero</label><input type="text" name="numero" class="form-control form-control-sm" value="{{ obj.numero }}"></div>
            <div class="f"><label>Complemento</label><input type="text" name="complemento" class="form-control form-control-sm" value="{{ obj.complemento }}"></div>
            <div class="f"><label>Bairro</label><input type="text" name="bairro" class="form-control form-control-sm" value="{{ obj.bairro }}"></div>
            <div class="f"><label>Cidade</label><input type="text" name="cidade" class="form-control form-control-sm" value="{{ obj.cidade }}"></div>
            <div class="f"><label>UF</label><input type="text" name="uf" class="form-control form-control-sm" value="{{ obj.uf }}"></div>
            <div class="f"><label>CEP</label><input type="text" name="cep" class="form-control form-control-sm" value="{{ obj.cep }}"></div>
          </div>
          <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Im√≥vel</button></div>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</section>

<section class="detail-body">
  <h3>Autuado(a)</h3>
  <p><strong>Nome/Raz√£o:</strong> {{ obj.nome_razao }}</p>
  <p><strong>CPF/CNPJ:</strong> {{ obj.cpf_cnpj }}</p>
  <p><strong>Contato:</strong> {{ obj.telefone }} | {{ obj.email }}</p>

  <h3>Endere√ßo</h3>
  <p>
    {{ obj.logradouro }}, {{ obj.numero }} {{ obj.complemento }} ‚Äì {{ obj.bairro }} ‚Äì {{ obj.cidade }}/{{ obj.uf }}<br>
    CEP: {{ obj.cep }}
  </p>

  {% if obj.latitude or obj.longitude %}
  <p><strong>Geo:</strong> {{ obj.latitude }} , {{ obj.longitude }}</p>
  {% endif %}

  <h3>Descri√ß√£o</h3>
  <p style="white-space: pre-line">{{ obj.descricao }}</p>

  <h3>Tipos de Infra√ß√£o</h3>
  {% if obj.tipos.all %}
    <ul>
      {% for t in obj.tipos.all %}
        <li>{{ t }}</li>
      {% endfor %}
    </ul>
  {% else %}
    <p><em>Nenhum tipo selecionado.</em></p>
  {% endif %}

  <h3>Fiscais</h3>
  {% with fs=obj.fiscais.all %}
    {% if fs %}
      <ul>
        {% for f in fs %}
          <li>{{ f.get_full_name|default:f.email }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p><em>Nenhum fiscal vinculado.</em></p>
    {% endif %}
  {% endwith %}
</section>

<section class="detail-body">
  <h3>üìë Ficha Completa</h3>
  <div class="table-wrapper">
    <table class="table table-striped table-sm">
      <thead>
        <tr><th colspan="4">Prazos e Valores</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Prazo Regulariza√ß√£o</strong></td>
          <td>{{ obj.prazo_regularizacao_data|date:"d/m/Y"|default:"‚Äî" }}</td>
          <td><strong>Valor da Infra√ß√£o</strong></td>
          <td>{% if obj.valor_infracao %}R$ {{ obj.valor_infracao|floatformat:2 }}{% else %}‚Äî{% endif %}</td>
        </tr>
        <tr>
          <td><strong>Valor Homologado (AIF)</strong></td>
          <td>{% if obj.valor_multa_homologado %}R$ {{ obj.valor_multa_homologado|floatformat:2 }}{% else %}‚Äî{% endif %}</td>
          <td><strong>Status</strong></td>
          <td>{{ obj.get_status_display }}</td>
        </tr>
      </tbody>
      <thead>
        <tr><th colspan="4">Pagamento</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Pago?</strong></td>
          <td>{{ obj.pago|yesno:"Sim,N√£o" }}</td>
          <td><strong>Valor Pago</strong></td>
          <td>{% if obj.valor_pago %}R$ {{ obj.valor_pago|floatformat:2 }}{% else %}‚Äî{% endif %}</td>
        </tr>
        <tr>
          <td><strong>Pago em</strong></td>
          <td>{{ obj.pago_em|date:"d/m/Y"|default:"‚Äî" }}</td>
          <td><strong>Forma</strong></td>
          <td>{{ obj.get_forma_pagamento_display|default:"‚Äî" }}</td>
        </tr>
        <tr>
          <td><strong>N¬∫ da Guia</strong></td>
          <td>{{ obj.guia_numero|default:"‚Äî" }}</td>
          <td><strong>Obs. Pagamento</strong></td>
          <td>{{ obj.observacao_pagamento|default:"‚Äî" }}</td>
        </tr>
      </tbody>
      <thead>
        <tr><th colspan="4">Dados Construtivos</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>√Årea (m¬≤)</strong></td>
          <td>{{ obj.area_m2|default:"‚Äî" }}</td>
          <td><strong>Testada (m)</strong></td>
          <td>{{ obj.testada_m|default:"‚Äî" }}</td>
        </tr>
        <tr>
          <td><strong>P√©-direito (m)</strong></td>
          <td>{{ obj.pe_direito_m|default:"‚Äî" }}</td>
          <td><strong>Mezanino (m¬≤)</strong></td>
          <td>{% if obj.mezanino %}{{ obj.area_mezanino_m2|default:"‚Äî" }}{% else %}‚Äî{% endif %}</td>
        </tr>
        <tr>
          <td><strong>Duplex</strong></td>
          <td>{{ obj.duplex|yesno:"Sim,N√£o" }}</td>
          <td><strong>Qtd. de c√¥modos</strong></td>
          <td>{{ obj.qtd_comodos|default:"‚Äî" }}</td>
        </tr>
        <tr>
          <td><strong>Compartimenta√ß√£o</strong></td>
          <td>{{ obj.compartimentacao|yesno:"Sim,N√£o" }}</td>
          <td><strong>Divis√≥rias</strong></td>
          <td>{{ obj.divisorias|yesno:"Sim,N√£o" }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section class="detail-body">
  <h3>üí∞ Multas / Enquadramentos</h3>
  {% with items=obj.multas.all %}
    {% if items %}
      <div class="table-wrapper">
        <div class="text-right" style="margin:0 0 6px;">
          <strong>Val. Homologado (AIF):</strong>
          R$ {{ obj.valor_multa_homologado|default:obj.total_multa|floatformat:2 }}
        </div>
        <table class="table table-striped table-sm">
          <thead>
            <tr>
              <th>Enquadramento</th>
              <th class="text-right">Val. Infra√ß√£o (AIF)</th>
              <th class="text-right">Vlr. Homologado (item)</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td>{{ it.enquadramento }}{% if it.descricao %}<div class="hint">{{ it.descricao }}</div>{% endif %}</td>
              <td class="text-right">R$ {{ obj.valor_infracao|default:obj.total_infracao_itens|floatformat:2 }}</td>
              <td class="text-right"><strong>R$ {{ it.valor_homologado|default:it.valor_unitario }}</strong></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
    {% else %}
      <p><em>Nenhum item de multa.</em></p>
    {% endif %}
  {% endwith %}

  <h3>üì∑ Galeria de Fotos (unificada)</h3>
  {% if galeria %}
    <div class="anexos-grid">
      {% for g in galeria %}
        <div class="anexo-item">
          <a href="{{ g.url }}" target="_blank" rel="noopener">
            <img src="{{ g.url }}" alt="Foto" class="thumb" loading="lazy">
          </a>
          <p class="anexo-legenda">
            <span class="badge bg-secondary">{{ g.label }}</span>
            {% if g.owner == 'AIF' and g.id %}
              <a class="btn btn-sm btn-secondary" href="{% url 'autoinfracao:editar' obj.pk %}?del_aif_anexo={{ g.id }}" onclick="return confirm('Remover esta foto do AIF?');" style="margin-left:6px;">Excluir</a>
            {% endif %}
          </p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p><em>Sem fotos para exibir.</em></p>
  {% endif %}
</section>

{% endblock %}
