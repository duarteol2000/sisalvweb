{% extends "core/base.html" %}
{% load static %}
{% load l10n %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'notificacoes/css/notificacoes.css' %}">
<style>
  .link-ver{ font-size:.85rem; color: var(--muted); text-decoration:none; margin-left:6px; }
  .link-ver:hover{ color: var(--accent); text-decoration: underline; }
  .doc-rel strong{ margin-right:6px; }
  .doc-rel code.proto{ margin-right:6px; }
  /* Grid de exibi√ß√£o no padr√£o dos cart√µes-tabela */
  .detail-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
  .detail-grid .f{ display:flex; flex-direction:column; }
  .detail-grid .f label{ display:block; font-weight:600; margin-bottom:4px; }
  .detail-grid .f input, .detail-grid .f select, .detail-grid .f textarea{ width:100%; }
  .detail-grid .f .v{ }
  @media (max-width: 1100px){ .detail-grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 700px){ .detail-grid{ grid-template-columns: 1fr; } }
  /* Mini-mapa Leaflet */
  #mini-map{ height:260px; min-height:220px; }
  /* Evita conflito de CSS global com tiles do Leaflet */
  .leaflet-container img{ max-width:none !important; }
  .leaflet-container{ background:#f3f4f6; }
</style>
<!-- Leaflet local (sem CDN) -->
<link rel="stylesheet" href="{% static 'vendor/leaflet/leaflet.css' %}">
{% endblock %}
{% block menu_notificacoes_active %}active{% endblock %}
{% block content %}

<header class="detail-header">
  <div class="left">
    <h1 class="page-title">üîé Detalhe da Notifica√ß√£o</h1>
    <div class="actions">
      <a href="{% url 'notificacoes:listar' %}" class="btn btn-sm btn-secondary">‚Üê Voltar</a>
      <a href="{% url 'notificacoes:editar' obj.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
      {% if aif %}
        <a href="{% url 'autoinfracao:detalhe' aif.pk %}" class="btn btn-sm btn-primary">Ver Auto de Infra√ß√£o</a>
      {% else %}
        <a href="{% url 'autoinfracao:from_notificacao' obj.pk %}" class="btn btn-sm btn-primary">Gerar Auto de Infra√ß√£o</a>
      {% endif %}
    </div>
  </div>
  <div class="right detail-meta">
    <div><strong>Protocolo:</strong> <code class="proto">{{ obj.protocolo }}</code></div>
    <div><strong>Status:</strong> {{ obj.get_status_display }}</div>
    <div><strong>Criada em:</strong> {{ obj.criada_em|date:"d/m/Y H:i" }}</div>
  </div>
</header>

{% if obj.denuncia or aif %}
<div class="detail-links" style="margin:.25rem 0 .5rem;">
  {% if obj.denuncia %}
    <div class="doc-rel"><strong>Den√∫ncia:</strong> <code class="proto">{{ obj.denuncia.protocolo }}</code> ‚Äî <a class="link-ver" href="{% url 'denuncias:detalhe' obj.denuncia.pk %}">+ver</a></div>
  {% endif %}
  {% if aif %}
    <div class="doc-rel"><strong>Auto de Infra√ß√£o:</strong> <code class="proto">{{ aif.protocolo }}</code> ‚Äî <a class="link-ver" href="{% url 'autoinfracao:detalhe' aif.pk %}">+ver</a></div>
  {% endif %}
  <div class="doc-rel"><strong>Pessoa vinculada:</strong>
    {% if obj.pessoa %}{{ obj.pessoa.nome_razao }} ({{ obj.pessoa.get_tipo_display }}){% else %}‚Äî{% endif %}
  </div>
  <div class="doc-rel"><strong>Im√≥vel vinculado:</strong>
    {% if obj.imovel %}{{ obj.imovel.logradouro }}{% if obj.imovel.numero %}, {{ obj.imovel.numero }}{% endif %} ‚Äî {{ obj.imovel.bairro }} ‚Äî {{ obj.imovel.cidade }}/{{ obj.imovel.uf }}{% if obj.imovel.inscricao %} ‚Ä¢ Inscri√ß√£o: {{ obj.imovel.inscricao }}{% endif %}{% else %}‚Äî{% endif %}
  </div>
</div>
{% endif %}

{% if not obj.pessoa or not obj.imovel %}
<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>Vincular Refer√™ncias</strong></div></div>
  <div class="table-wrap">
    <div class="detail-grid">
      {% if not obj.pessoa %}
      <form method="post" action="{% url 'notificacoes:vincular_pessoa' obj.pk %}" novalidate>
        {% csrf_token %}
        <div class="detail-grid">
          <div class="f"><label>Tipo</label><select name="tipo" class="form-select form-select-sm"><option value="PF">PF</option><option value="PJ">PJ</option></select></div>
          <div class="f"><label>Nome/Raz√£o</label><input type="text" name="nome_razao" class="form-control form-control-sm" value="{{ obj.nome_razao }}"></div>
          <div class="f"><label>Doc. Tipo</label><select name="doc_tipo" class="form-select form-select-sm"><option value="OUTRO">Outro</option><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select></div>
          <div class="f"><label>Doc. N√∫mero</label><input type="text" name="doc_num" class="form-control form-control-sm" value="{{ obj.cpf_cnpj }}"></div>
          <div class="f"><label>E-mail</label><input type="text" name="email" class="form-control form-control-sm" value="{{ obj.email }}" placeholder="ex.: usuario@dominio.com (opcional)"></div>
          <div class="f"><label>Telefone</label><input type="text" name="telefone" class="form-control form-control-sm" value="{{ obj.telefone }}"></div>
        </div>
        <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Pessoa</button></div>
      </form>
      {% endif %}

      {% if not obj.imovel %}
      <form method="post" action="{% url 'notificacoes:vincular_imovel' obj.pk %}" novalidate>
        {% csrf_token %}
        <div class="detail-grid">
          <div class="f"><label>Inscri√ß√£o</label><input type="text" name="inscricao" class="form-control form-control-sm"></div>
          <div class="f"><label>Logradouro</label><input type="text" name="logradouro" class="form-control form-control-sm" value="{{ obj.logradouro }}"></div>
          <div class="f"><label>N√∫mero</label><input type="text" name="numero" class="form-control form-control-sm" value="{{ obj.numero }}"></div>
          <div class="f"><label>Complemento</label><input type="text" name="complemento" class="form-control form-control-sm" value="{{ obj.complemento }}"></div>
          <div class="f"><label>Bairro</label><input type="text" name="bairro" class="form-control form-control-sm" value="{{ obj.bairro }}"></div>
          <div class="f"><label>Cidade</label><input type="text" name="cidade" class="form-control form-control-sm" value="{{ obj.cidade }}"></div>
          <div class="f"><label>UF</label><input type="text" name="uf" class="form-control form-control-sm" value="{{ obj.uf }}"></div>
          <div class="f"><label>CEP</label><input type="text" name="cep" class="form-control form-control-sm" value="{{ obj.cep }}"></div>
        </div>
        <div class="form-actions" style="margin-top:6px;"><button class="btn btn-sm btn-primary">Vincular Im√≥vel</button></div>
      </form>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<!-- Dados do Notificado -->
<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>Dados do Notificado</strong></div></div>
  <div class="table-wrap">
    <div class="detail-grid">
      <div class="f"><label>Nome/Raz√£o</label><div class="v">{{ obj.nome_razao }}</div></div>
      <div class="f"><label>CPF/CNPJ</label><div class="v">{{ obj.cpf_cnpj|default:"‚Äî" }}</div></div>
      <div class="f"><label>RG</label><div class="v">{{ obj.rg|default:"‚Äî" }}</div></div>
      <div class="f"><label>Telefone</label><div class="v">{{ obj.telefone|default:"‚Äî" }}</div></div>
      <div class="f"><label>E-mail</label><div class="v">{{ obj.email|default:"‚Äî" }}</div></div>
      <div class="f"><label>Tipo de Pessoa</label><div class="v">{{ obj.get_pessoa_tipo_display }}</div></div>
    </div>
  </div>
  </div>

<!-- Endere√ßo -->
<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>Endere√ßo</strong></div></div>
  <div class="table-wrap">
    <div class="detail-grid">
      <div class="f"><label>Logradouro</label><div class="v">{{ obj.logradouro }}</div></div>
      <div class="f"><label>N√∫mero</label><div class="v">{{ obj.numero|default:"‚Äî" }}</div></div>
      <div class="f"><label>Complemento</label><div class="v">{{ obj.complemento|default:"‚Äî" }}</div></div>
      <div class="f"><label>Ponto de Refer√™ncia</label><div class="v">{{ obj.pontoref_oco|default:"‚Äî" }}</div></div>
      <div class="f"><label>Bairro</label><div class="v">{{ obj.bairro }}</div></div>
      <div class="f"><label>Cidade</label><div class="v">{{ obj.cidade }}</div></div>
      <div class="f"><label>UF</label><div class="v">{{ obj.uf }}</div></div>
      <div class="f"><label>CEP</label><div class="v">{{ obj.cep|default:"‚Äî" }}</div></div>
      {# Removido: coordenadas detalhadas aqui para evitar duplicidade; agora mostramos junto √† etiqueta do mapa #}
    </div>
  </div>
</div>

{% comment %}
  Prefer√™ncia de coordenadas para exibi√ß√£o do mapa:
  1) Im√≥vel vinculado (se tiver latitude/longitude)
  2) Den√∫ncia vinculada (local_oco_lat/local_oco_lng)
  3) Pr√≥pria Notifica√ß√£o (latitude/longitude)
{% endcomment %}
{% if obj.imovel and obj.imovel.latitude or obj.denuncia and obj.denuncia.local_oco_lat or obj.latitude %}
<!-- Localiza√ß√£o no mapa -->
<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>Localiza√ß√£o no Mapa</strong></div></div>
  <div class="table-wrap">
    {% if obj.imovel and obj.imovel.latitude %}
      <div id="mini-map" data-lat="{{ obj.imovel.latitude|floatformat:'6'|unlocalize }}" data-lng="{{ obj.imovel.longitude|floatformat:'6'|unlocalize }}"></div>
    {% elif obj.denuncia and obj.denuncia.local_oco_lat %}
      <div id="mini-map" data-lat="{{ obj.denuncia.local_oco_lat|floatformat:'6'|unlocalize }}" data-lng="{{ obj.denuncia.local_oco_lng|floatformat:'6'|unlocalize }}"></div>
    {% else %}
      <div id="mini-map" data-lat="{{ obj.latitude|floatformat:'6'|unlocalize }}" data-lng="{{ obj.longitude|floatformat:'6'|unlocalize }}"></div>
    {% endif %}
    <div class="map-meta" style="margin-top:6px; color:#6b7280; font-size:.85rem;">
      {% if obj.imovel and obj.imovel.latitude %}
        <strong>Fonte das coordenadas:</strong> Im√≥vel ‚Äî Latitude: {{ obj.imovel.latitude|floatformat:'6'|localize }} ‚Ä¢ Longitude: {{ obj.imovel.longitude|floatformat:'6'|localize }}
      {% elif obj.denuncia and obj.denuncia.local_oco_lat %}
        <strong>Fonte das coordenadas:</strong> Den√∫ncia ‚Äî Latitude: {{ obj.denuncia.local_oco_lat|floatformat:'6'|localize }} ‚Ä¢ Longitude: {{ obj.denuncia.local_oco_lng|floatformat:'6'|localize }}
      {% else %}
        <strong>Fonte das coordenadas:</strong> Notifica√ß√£o ‚Äî Latitude: {{ obj.latitude|floatformat:'6'|localize }} ‚Ä¢ Longitude: {{ obj.longitude|floatformat:'6'|localize }}
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<!-- Descri√ß√£o -->
<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>Descri√ß√£o</strong></div></div>
  <div class="table-wrap">
    <div class="detail-grid">
      <div class="f span-3" style="grid-column:1 / -1;">
        <div class="v" style="white-space: pre-line;">{{ obj.descricao }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Prazos -->
{% if obj.prazo_regularizacao %}
<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>Prazos</strong></div></div>
  <div class="table-wrap">
    <div class="detail-grid">
      <div class="f"><label>Prazo para Regulariza√ß√£o</label><div class="v">{{ obj.prazo_regularizacao|date:"d/m/Y" }}</div></div>
      <div class="f"><label>Status</label><div class="v">{{ obj.get_status_display }}</div></div>
    </div>
  </div>
</div>
{% endif %}

<!-- Ficha completa -->
<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>üìë Ficha Completa</strong></div></div>
  <div class="table-wrap">
    <div class="detail-grid">
      <div class="f"><label>Documento (tipo)</label><div class="v">{{ obj.get_documento_tipo_display|default:"‚Äî" }}</div></div>
      <div class="f"><label>Status</label><div class="v">{{ obj.get_status_display }}</div></div>
      <div class="f"><label>Criada em</label><div class="v">{{ obj.criada_em|date:"d/m/Y H:i" }}</div></div>

      <div class="f"><label>Latitude</label><div class="v">{% if obj.latitude %}{{ obj.latitude|floatformat:'6' }}{% else %}‚Äî{% endif %}</div></div>
      <div class="f"><label>Longitude</label><div class="v">{% if obj.longitude %}{{ obj.longitude|floatformat:'6' }}{% else %}‚Äî{% endif %}</div></div>

      <div class="f"><label>√Årea (m¬≤)</label><div class="v">{{ obj.area_m2|default:"‚Äî" }}</div></div>
      <div class="f"><label>Testada (m)</label><div class="v">{{ obj.testada_m|default:"‚Äî" }}</div></div>
      <div class="f"><label>P√©‚Äëdireito (m)</label><div class="v">{{ obj.pe_direito_m|default:"‚Äî" }}</div></div>
      <div class="f"><label>Duplex</label><div class="v">{{ obj.duplex|yesno:"Sim,N√£o" }}</div></div>
      <div class="f"><label>Qtd. c√¥modos</label><div class="v">{{ obj.qtd_comodos|default:"‚Äî" }}</div></div>
      <div class="f"><label>Compartimenta√ß√£o</label><div class="v">{{ obj.compartimentacao|yesno:"Sim,N√£o" }}</div></div>
      <div class="f"><label>Divis√≥rias</label><div class="v">{{ obj.divisorias|yesno:"Sim,N√£o" }}</div></div>
      <div class="f"><label>Mezanino</label><div class="v">{{ obj.mezanino|yesno:"Sim,N√£o" }}</div></div>
      <div class="f"><label>√Årea mezanino (m¬≤)</label><div class="v">{{ obj.area_mezanino_m2|default:"‚Äî" }}</div></div>
    </div>
  </div>
</div>

<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>üì∑ Galeria de Fotos (unificada)</strong></div><div class="text-muted small">Total: {{ galeria|length }}</div></div>
  <div class="table-wrap">
    {% if galeria %}
      <div class="anexos-grid">
        {% for g in galeria %}
          <div class="anexo-item">
            <a href="{{ g.url }}" target="_blank" rel="noopener">
              <img src="{{ g.url }}" alt="Foto" class="thumb" loading="lazy">
            </a>
            <p class="anexo-legenda">
              <span class="badge bg-secondary">{{ g.label }}</span>
              {% if g.owner == 'NOT' and g.id %}
                <a class="btn btn-sm btn-secondary" href="{% url 'notificacoes:editar' obj.pk %}?del_anexo={{ g.id }}" onclick="return confirm('Remover esta foto da Notifica√ß√£o?');" style="margin-left:6px;">Excluir</a>
              {% endif %}
            </p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted" style="margin:8px 0;">Sem fotos para exibir.</p>
    {% endif %}
  </div>
</div>

<div class="card p-0 table-card shadow-sm" style="margin-top:10px;">
  <div class="table-head"><div><strong>üìÑ Documentos Anexos (Notifica√ß√£o)</strong></div><div class="text-muted small">Total: {{ docs|length }}</div></div>
  <div class="table-wrap">
    {% if docs %}
      <ul>
      {% for d in docs %}
        <li><a href="{{ d.arquivo.url }}" target="_blank" rel="noopener">{{ d.arquivo.name|cut:"notificacoes/anexos/" }}</a></li>
      {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted" style="margin:8px 0;">Sem documentos anexados.</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/leaflet/leaflet.js' %}"></script>
<script>
(function(){
  const el = document.getElementById('mini-map');
  if(!el) return;

  // üîß Normaliza√ß√£o defensiva: v√≠rgula -> ponto, remove espa√ßos
  const rawLat = (el.dataset.lat || '').trim().replace(/\s/g,'').replace(/,/g,'.');
  const rawLng = (el.dataset.lng || '').trim().replace(/\s/g,'').replace(/,/g,'.');

  const lat = Number(rawLat);
  const lng = Number(rawLng);
  if(Number.isNaN(lat) || Number.isNaN(lng)) return;

  function inBrazilBox(a,b){ return a >= -34 && a <= 5 && b >= -74 && b <= -34; }
  let lat1 = lat, lng1 = lng, swapped = false;
  if(!inBrazilBox(lat1, lng1) && inBrazilBox(lng1, lat1)){
    swapped = true;
    const tmp = lat1; lat1 = lng1; lng1 = tmp;
  }

  const map = L.map('mini-map', {zoomControl: true, attributionControl: true});
  const z = 17;
  map.setView([lat1, lng1], z);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  const m = L.circleMarker([lat1, lng1], {radius:8, color:'#111827', fillColor:'#10b981', fillOpacity:.9, weight:2});
  m.addTo(map).bindTooltip('Local da Notifica√ß√£o', {direction:'top'});
  if(swapped){
    const note = document.createElement('div');
    note.textContent = 'Coordenadas parecem invertidas (lat/lng). Exibindo com corre√ß√£o visual.';
    note.style.cssText = 'position:absolute;left:6px;bottom:6px;background:rgba(255,255,255,.95);border:1px solid #e5e7eb;border-radius:6px;padding:4px 6px;font-size:.78rem;z-index:401;max-width:70%';
    el.appendChild(note);
  }
  setTimeout(()=> map.invalidateSize(), 50);
})();
</script>
{% endblock %}
